---
title: "R scripts for metrics analysis"
output:
  word_document: default
  html_notebook: default
  pdf_document: default
  html_document:
    df_print: paged
df_print: paged
---
**Aanalys of parameters associated with vbi failure**:

- nrd
- yeild
- fraction of double error

```{r}
#0.	Data. Install tidyverse, gridExtra, ggpubr, tinytex, readr, readxl,class
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(readr)
library("readxl")
```
- read the data
```{r}
#read_excel("C:/Users/ia1/Documents/R_work/dbViz/high_vbi_Oct19_Jan20_3.xlsx")->vpn1
#head(vpn1)
#read_excel("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/NV_data_spikes_4Feb20.xlsx")->vpn1
#read_excel("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/vbi_more009_2.xlsx")->vpn1
#duplicated where library id =(null)0 topup, to make conts for the same plates _3
#read_excel("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/vbi_more009_3.xlsx")->vpn1
#head(vpn1)
#read_excel("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/NovaSeq_data_FAIL_11FEb202.xlsx")->vpn1
read_excel("C:/Users/ia1/Documents/irina_docs/March2020_NPG/NV_data_spikes/NovaSeq_data_vbi_25FEb202.xlsx")->vpn1
#head(vpn1)
tail(vpn1,10)

#tail(vpn1$nrd)


#----------------------------did not work!!! ....

#---------------------in nrd (null) into 0: 1. specify this nrd col as numeric (then NA will arrive) 2. mutate(nrd=replace_na(nrd,0))

#read_csv("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/NovaSeq_data_vbi_18FEb202.xlsx")->vpn2

#read_excel("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/NovaSeq_data_vbi_18FEb202.xlsx", sheet = 1, col_names = TRUE, col_types = cols(nrd = numeric)) -> vpn2
#col_types=cols(nrd = col_double()))->vpn2


#read_tsv("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/vbi_more008_18Feb20.txt", col_types=cols(nrd = #col_()))->vpn3

#read_tsv("C:/Users/ia1/Documents/irina_docs/JanFeb2020_NPG/NV_data_spikes/vbi_more008_18Feb20.txt")->vpn3

#head(vpn3$nrd)

#head(vpn1)
```
- filter and rename: 14 needed columns
```{r}
vpn1 %>%
  select(id_iseq_ext_pr_metrics_tmp,created,plate_barcode,id_run,analysis_start_date,instrument_id,target_autosome_gt_coverage_threshold,verify_bam_id_score,double_error_fraction,yield,yield_q20,yield_q30,num_reads,nrd) %>%
  rename(index=id_iseq_ext_pr_metrics_tmp, anal_start=analysis_start_date, cov_thr=target_autosome_gt_coverage_threshold, vbi=verify_bam_id_score,defr=double_error_fraction) -> needed
needed
head(needed)

vpn1 %>%
  select(id_iseq_ext_pr_metrics_tmp,created,verify_bam_id_score,supplier_sample_name,library_id,gc_fraction_forward_read,gc_fraction_reverse_read,pre_adapter_min_total_qscore,ref_bias_min_total_qscore,insert_size_mean,insert_size_std,target_proper_pair_mapped_reads_fraction,sequence_error_rate
 ) %>%
  rename(index=id_iseq_ext_pr_metrics_tmp, samp_name=supplier_sample_name, vbi=verify_bam_id_score, gc_fwd=gc_fraction_forward_read, gc_rev=gc_fraction_reverse_read, Q_preadapt=pre_adapter_min_total_qscore, Q_refbias=ref_bias_min_total_qscore,me_ins=insert_size_mean, sd_ins=insert_size_std,PRfrac=target_proper_pair_mapped_reads_fraction,seq_err=sequence_error_rate) %>%
  mutate(cv_ins=sd_ins/me_ins)%>%
  mutate(gc_bias=gc_fwd/gc_rev)-> mbneeded

head(mbneeded)

```
- vbi vs other features
```{r fig, fig.width=12, fig.height=8}
pp1 <- ggplot(mbneeded,aes (x=Q_refbias, y=vbi, fill=vbi)) +
  geom_point(shape=21, size=4, show.legend = FALSE)+
  ggtitle(" Q_refbias VBI,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("vbi")+
  xlab("Qrefbias")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
pp1

pp2 <- ggplot(mbneeded,aes (x=Q_preadapt, y=vbi, fill=vbi)) +
  geom_point(shape=21, size=4, show.legend = FALSE)+
  ggtitle(" Q_preadapt VBI,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("vbi")+
  xlab("Q_preadapt")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
pp2

pp3 <- ggplot(mbneeded,aes (x=cv_ins, y=vbi, fill=vbi)) +
  geom_point(shape=23, size=4, show.legend = FALSE)+
  ggtitle(" cv_ins vs VBI,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("vbi")+
  xlab("cv insert")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
pp3

pp4 <- ggplot(mbneeded,aes (x=gc_bias, y=vbi, fill=vbi)) +
  geom_point(shape=21, size=4, show.legend = FALSE)+
  ggtitle(" GCbias vs VBI,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("vbi")+
  xlab("GC_bias")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
pp4

pp5 <- ggplot(mbneeded,aes (x=seq_err, y=vbi, fill=vbi)) +
  geom_point(shape=21, size=4, show.legend = FALSE)+
  ggtitle(" seq-error vs VBI,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("vbi")+
  xlab("seq_error")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
pp5

pp6 <- ggplot(mbneeded,aes (x=PRfrac, y=vbi, fill=vbi)) +
  geom_point(shape=21, size=4, show.legend = FALSE)+
  ggtitle(" PR frac vs VBI,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("vbi")+
  xlab("PR frac")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
pp6


ggarrange(pp1,pp2,pp3,pp4,pp5,pp6, ncols=1)

```




- plot vbi failure by NV instrument
```{r, echo=FALSE}
p3<-ggplot(needed,aes (instrument_id)) +
  #geom_boxplot(aes(x=instrument, fill=instrument))+
  geom_histogram(stat="count",show.legend = FALSE)+
  #geom_boxplot(aes(x=instrument, y=vbi, fill=instrument),show.legend = FALSE)+
  ggtitle(" Frequency of NV failures on vbi\n Oct19 - late Feb20")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("instrument")+
  ylab("counts")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p3

p4<-ggplot(needed,aes (plate_barcode,fill=plate_barcode)) +
  #geom_boxplot(aes(x=instrument, fill=instrument))+
  geom_histogram(stat="count",show.legend = FALSE)+
  #geom_boxplot(aes(x=instrument, y=vbi, fill=instrument),show.legend = FALSE)+
  ggtitle(" Frequency of plate failures on vbi\n Oct19 - late Feb20")+
  theme_minimal(base_size = 10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("plate")+
  ylab("counts")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p4


```
- which run is the worst?
```{r fig, fig.width=12, fig.height=4}

#{r fig1, fig.height = 3, fig.width = 5}
#{fig.height=20}
p3r<-ggplot(needed,aes (id_run)) +
  #geom_boxplot(aes(x=instrument, fill=instrument))+
  geom_histogram(stat="count",show.legend = FALSE)+
  #geom_boxplot(aes(x=instrument, y=vbi, fill=instrument),show.legend = FALSE)+
  ggtitle(" Frequency of NV failures on vbi \n per run, Oct19 - late Feb20")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("run")+
  ylab("counts")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p3r

```
-group by machine and by plate
  #group_by(Category) %>%
   # summarise(MeanLength=mean(Length),SD=sd(Length))
```{r}
needed %>%
  group_by(instrument_id) %>%
  summarise(MeanVbi=mean(vbi),SDvbi=sd(vbi),COUNT=n()) %>%
arrange(desc(COUNT))-> vbi_instrument
  vbi_instrument

```
   



- plot vbi score per plate
````{r fig, fig.width=12, fig.height=4}
p <- ggplot(needed, aes(factor(plate_barcode), vbi, fill=plate_barcode))+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  ggtitle("VBI score per plate")
p
#p + geom_violin(aes(fill = factor(instrument_id)),show.legend = FALSE)+ggtitle("VBI score per plate and machine")
p + geom_boxplot(aes(fill = factor(plate_barcode)),show.legend = FALSE)+ggtitle("VBI score per plate")

#----------------
pm <- ggplot(needed, aes(factor(instrument_id), vbi, fill=instrument_id))+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  ggtitle("VBI score per machine")
pm


pm + geom_boxplot(aes(fill = factor(instrument_id)),show.legend = FALSE)+ggtitle("VBI score per instrument")

p + geom_boxplot(aes(fill = factor(id_run)),show.legend = FALSE)+ggtitle("VBI score per run")



```

```{r, echo=FALSE}

```
box plot vbi values per machine
```{r, echo=FALSE}

 p+geom_boxplot(aes(x=instrument_id, y=vbi, fill=instrument_id),show.legend = FALSE)+ggtitle("VBI score per machine")+xlab("instrument")

```
plot vbi per instrument, box plot
```{r, echo=FALSE}
p1<-ggplot(vpn1,aes (verify_bam_id_score)) +
  #geom_violin(stat="ydensity")+
  geom_boxplot(aes(x=instrument_id, y=verify_bam_id_score, fill=instrument_id),show.legend = FALSE)+
  ggtitle("VBI per instrument")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("instrument")+
  #xlab(" ")+
  #theme(axis.title.x=element_blank(),
   #     axis.text.x=element_blank(),
   #     axis.ticks.x=element_blank())+
  ylab("VBI")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p1
```

plot:
- vbi failures by plate and instrument
```{r, echo=FALSE}
p61<-ggplot(vpn1,aes (plate_barcode, fill=plate_barcode)) +
  #geom_boxplot(aes(x=instrument, fill=instrument))+
  geom_histogram(stat="count",show.legend = FALSE)+
  #geom_boxplot(aes(x=instrument, y=vbi, fill=instrument),show.legend = FALSE)+
  #control colors of fill
  ggtitle(" vbi fails by plate, Oct19 - late Feb20")+
  theme_minimal(base_size = 15)+
  #theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.x=element_blank(),
   axis.text.x=element_blank(),
   axis.ticks.x=element_blank())+
  
  #xlab("plate")+
  ylab("frequency")
  #theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p61
p61 + facet_wrap( ~ instrument_id)+ggtitle(" vbi fails by plate and instrument,\n Oct19 - early Feb20")

```
- run number per vbi
```{r, echo=FALSE}
#p21r <- ggplot(vpn1,aes (x=yield, y=verify_bam_id_score, fill=verify_bam_id_score)) +
p21r <- ggplot(vpn1,aes (x=yield, y=num_reads, fill=num_reads)) +
  geom_point(shape=22, size=4, show.legend = FALSE)+
  ggtitle(" read amount vs yield,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #ylab("vbi")+
  ylab("yield")+
  xlab(" read amount")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p21r

```




plot
- double_error_fraction per instrument, box (it is computed for vbi in (1%,5%) only)
```{r, echo=FALSE}
p4<-ggplot(vpn1,aes (double_error_fraction)) +
  #geom_violin(stat="ydensity")+
  geom_boxplot(aes(x=instrument_id,    y=double_error_fraction,fill=instrument_id),show.legend = FALSE)+
  ggtitle("double error per instrument")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("instrument")+
  #xlab(" ")+
  #theme(axis.title.x=element_blank(),
   #     axis.text.x=element_blank(),
   #     axis.ticks.x=element_blank())+
  ylab("frac double error")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p4
```
plot  
- vbi per time
```{r, echo=FALSE}
p21 <- ggplot(vpn1,aes (x=created, y=verify_bam_id_score, fill=verify_bam_id_score)) +
  geom_point(shape=22, size=4, show.legend = FALSE)+
  ggtitle(" VBI per time,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("vbi")+
  xlab("")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p21

```
plate per time
```{r}
p29 <- ggplot(vpn1,aes (x=created, y=plate_barcode, fill=plate_barcode)) +
  geom_point(shape=22, size=4, show.legend = FALSE)+
  ggtitle(" plate per time,\n Oct 2019 - late Feb 2020")+
  theme_grey(base_size = 10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("plate")+
  xlab("")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p29
```
plot instrument oper time
```{r}
p30 <- ggplot(vpn1,aes (x=created, y=instrument_id, fill=instrument_id)) +
  geom_point(shape=22, size=4, show.legend = FALSE)+
  ggtitle(" instrument per time,\n Oct 2019 - late Feb 2020")+
  theme_grey(base_size = 14)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("instrument")+
  xlab("")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p30

```

trying experiment with groupping per time- nothing good...

```{r, echo=FALSE}

vpn1 %>%
  select(processing_start_date)%>%
  ggplot(aes(x=processing_start_date))+
  geom_bar()  


vpn1 %>%
  select(processing_start_date, instrument_id)%>%
ggplot(aes(x=processing_start_date,y=instrument_id))+
  geom_col()  

vpn1 %>%
  group_by(processing_start_date,instrument_id) %>%
  count()->tic

tic %>% 
  group_by(processing_start_date) %>%
  summarise(instr2=mean(n))->sum_instr

sum_instr %>%
    ggplot(aes(x=processing_start_date, y=instr2))+
  geom_point(shape=22, size=4,show.legend = FALSE)
  #geom_col()

  


  
```
plot 
- double_error_fraction per time


```{r, echo=FALSE}
p22 <- ggplot(vpn1,aes (x=created, y=double_error_fraction, fill=double_error_fraction)) +
  geom_point(shape=22, size=4,show.legend = FALSE)+
  ggtitle(" double_error_fraction per time,\n Oct 2019 -late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("fr_double_error")+
  xlab("")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p22
```
plot
- NRD per time
```{r, echo=FALSE}
p23 <- ggplot(vpn1,aes (x=processing_start_date, y=nrd, fill=nrd)) +
  geom_point(shape=22, size=4, show.legend = FALSE)+
  ggtitle(" NRD per time,\n Oct 2019 -late Feb 2020")+
  theme_minimal(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("NRD")+
  xlab("")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p23
```
correlations: 
- vbi Vs nrd vs fr_double error 
```{r}

#--------------------------example fuction: corr and sum up input vectors; returns other vector

correlate_columns <- function(col1,col2){
  nnrd<-data.matrix(col1)
fde<-data.matrix(col2)
#nnrd[10]
Rna<-cor(fde,nnrd)#returns the last computed
print(Rna)
sum_vec=nnrd+fde
return(sum_vec)
}

col1=vpn1[69]#nrd
col2=vpn1[41]#fr double error
col3=vpn1[39]#vbi
col4=vpn1[44]#yield
rr<-correlate_columns(col3,col4)
#rr
rr1<-correlate_columns(col1,col3)
rr2<-correlate_columns(col1,col4)
rr3<-correlate_columns(col1,col2)
#rr1

```
plot correlation
```{r, echo=FALSE}
p24 <- ggplot(vpn1,aes (x=double_error_fraction, y=nrd, fill=nrd)) +
  geom_point(shape=22, size=4)+
  ggtitle(" NRD vs double error fraction,\n Oct 2019 - late Feb 2020")+
  theme_minimal(base_size = 15)+
  #theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("NRD")+
  xlab("frac double error")+
  geom_smooth(show.legend = FALSE)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p24
```
-profile some plots

```{r}
#instal profvis
library(profvis)
profvis({
  data(vpn1, package = "ggplot2")

  p30 <- ggplot(vpn1,aes (x=created, y=instrument_id, fill=instrument_id)) +
    geom_point(shape=22, size=4, show.legend = FALSE)+
    ggtitle(" instrument per time,\n Oct 2019 - late Feb 2020")+
    theme_grey(base_size = 14)+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    ylab("instrument")+
    xlab("")+
    theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p30

})
```

